<!DOCTYPE html>
<html>
<head>
    <title>Peta Desa Indonesia (Smart Load)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; background-color: #f0f0f0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* UI Styles */
        .search-box { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; background: white; padding: 8px 15px; border-radius: 50px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); display: flex; gap: 5px; width: 90%; max-width: 400px; }
        input { border: none; outline: none; flex-grow: 1; padding: 8px; }
        button { background-color: #007bff; color: white; border: none; border-radius: 20px; padding: 8px 20px; cursor: pointer; font-weight: bold; }
        
        .info-status { position: absolute; bottom: 20px; left: 20px; z-index: 1000; background: white; padding: 5px 10px; border-radius: 5px; font-size: 11px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* LABEL STYLE */
        .leaflet-tooltip.label-desa-style { background: transparent; border: none; box-shadow: none; }
        .label-desa-text { color: #000; font-weight: 800; font-size: 10px; text-align: center; white-space: normal; width: 100px; display: block; margin-left: -50px; text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff; transform: translate(0, 0); }
        .mode-bersih .label-desa-style { display: none !important; }
    </style>
</head>
<body>

    <div class="search-box">
        <input type="text" id="inputCari" placeholder="Cari Desa/Kecamatan..." onkeypress="cekEnter(event)">
        <button onclick="cariDesa()">Cari</button>
    </div>
    
    <div class="info-status">
        Loaded: <span id="countKec">0</span> Kec | <span id="countDesa">0</span> Desa
    </div>

    <div id="map" class="mode-bersih"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script src="spatial_index.js"></script>

    <script>
        var map = L.map('map').setView([-7.0, 112.0], 9); // View Awal Jawa Timur
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        var layerGroup = new L.featureGroup().addTo(map);
        var loadedFiles = []; // Mencatat file apa saja yang sudah dimuat
        var searchIndex = {}; // Untuk pencarian
        var totalDesa = 0;

        function getRandomColor() {
            var l='0123456789ABCDEF'; var c='#'; for(var i=0;i<6;i++)c+=l[Math.floor(Math.random()*16)]; return c;
        }

        // --- FUNGSI 1: MENERIMA DATA DARI FILE PECAHAN ---
        window.terimaDataPecahan = function(listDesa) {
            listDesa.forEach(function(desa) {
                var latlngs = desa.Koordinat.map(c => [parseFloat(c[0]), parseFloat(c[1])]);
                var polygon = L.polygon(latlngs, {
                    color: "white", weight: 1, fillColor: getRandomColor(), fillOpacity: 0.6
                });

                var labelHtml = '<span class="label-desa-text">' + desa.Desa + '</span>';
                polygon.bindTooltip(labelHtml, { permanent: true, direction: "center", className: "label-desa-style", interactive: false });
                
                var popup = `<b>${desa.Desa}</b><br>Kec. ${desa.Kecamatan}<br>Kab. ${desa.Kabupaten}`;
                polygon.bindPopup(popup);

                polygon.on('mouseover', function() { this.setStyle({weight:3, fillOpacity:0.9}); this.openTooltip(); });
                polygon.on('mouseout', function() { this.setStyle({weight:1, fillOpacity:0.6}); });

                layerGroup.addLayer(polygon);
                
                // Simpan ke index pencarian
                var key = desa.Desa.toLowerCase();
                if(!searchIndex[key]) searchIndex[key] = [];
                searchIndex[key].push(polygon);
                searchIndex[desa.Kecamatan.toLowerCase()] = []; // Simpan nama kec juga
                
                totalDesa++;
            });
            document.getElementById('countDesa').innerText = totalDesa;
            
            // Cek label sekali
            checkZoomLabel();
        };

        // --- FUNGSI 2: SMART LOADER (INTI TAHAP 2) ---
        function checkAndLoadData() {
            if (typeof spatialIndex === 'undefined') return;

            var mapBounds = map.getBounds(); // Batas layar saat ini
            var loadedCount = 0;

            spatialIndex.forEach(function(area) {
                // Konversi bounds area dari JSON ke Leaflet Bounds
                var areaBounds = L.latLngBounds(area.bounds[0], area.bounds[1]);

                // Logika: Apakah kotak kecamatan ini bersentuhan dengan layar kita?
                if (mapBounds.intersects(areaBounds)) {
                    
                    // Jika YA, dan belum pernah dimuat, LOAD SEKARANG!
                    if (!loadedFiles.includes(area.file)) {
                        console.log("Memuat area: " + area.kecamatan);
                        
                        var script = document.createElement('script');
                        script.src = 'Database_Pecahan/' + area.file;
                        document.head.appendChild(script);
                        
                        loadedFiles.push(area.file);
                    }
                    loadedCount++;
                }
            });
            document.getElementById('countKec').innerText = loadedCount;
        }

        // --- EVENT LISTENER ---
        // Jalankan pengecekan setiap kali peta digeser atau di-zoom
        map.on('moveend', checkAndLoadData);
        
        // Jalankan sekali di awal
        setTimeout(checkAndLoadData, 1000);


        // --- FITUR ZOOM LABEL (Sama seperti sebelumnya) ---
        function checkZoomLabel() {
            var z = map.getZoom();
            if(z < 13) document.getElementById('map').classList.add('mode-bersih');
            else document.getElementById('map').classList.remove('mode-bersih');
        }
        map.on('zoomend', checkZoomLabel);

        // --- PENCARIAN ---
        function cariDesa() {
            var val = document.getElementById('inputCari').value.trim().toLowerCase();
            
            // Coba cari di memori dulu
            if (searchIndex[val]) {
                 zoomTo(searchIndex[val]);
            } else {
                // Jika tidak ketemu, cari di Spatial Index (Mungkin datanya belum dimuat)
                var foundInIndex = spatialIndex.find(k => k.kecamatan.toLowerCase() === val || k.kabupaten.toLowerCase() === val);
                
                if (foundInIndex) {
                    // Paksa load file-nya dulu
                    var s = document.createElement('script');
                    s.src = 'Database_Pecahan/' + foundInIndex.file;
                    s.onload = function() {
                         // Setelah loaded, coba cari lagi
                         alert("Data " + val + " baru saja dimuat. Klik Cari sekali lagi.");
                    };
                    document.head.appendChild(s);
                    loadedFiles.push(foundInIndex.file);
                    
                    // Zoom ke area tersebut
                    var b = L.latLngBounds(foundInIndex.bounds[0], foundInIndex.bounds[1]);
                    map.flyToBounds(b);
                } else {
                    alert("Tidak ditemukan.");
                }
            }
        }
        
        function zoomTo(layers) {
            var group = L.featureGroup(layers);
            map.flyToBounds(group.getBounds());
            setTimeout(() => { if(map.getZoom()<14) map.setZoom(14); }, 1500);
        }
        function cekEnter(e) { if(e.keyCode === 13) cariDesa(); }

    </script>
</body>
</html>